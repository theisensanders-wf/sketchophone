{% extends "themes/base.html" %}

{% block style %}
    <style>

        h2 img {
            padding-right: 20px;
        }

        {# Hide Created Column on Mobile #}
        @media (max-width: 480px) {
            .col-created {display: none;}
        }

        div.accordion-inner {
            overflow-x: scroll;
        }

    </style>
{% endblock %}

{% block content %}

    <div class="span10 offset1">
        <h2>
            {% if user.is_facebook_user() %}
                <img src="https://graph.facebook.com/{{ user.facebook_id }}/picture?width=100&height=100" width="100" height="100">
                {{ user.display_name }} <span class="muted" style="font-size: 20px">({{ user.username }})</span>
            {% else %}
                <img src="{{ url_for('static', filename="img/blank-facebook.jpg") }}" width="100" height="100">
                {{ user.display_name }}
            {% endif %}
        </h2>

        <hr>
        <div id = "alert_placeholder"></div>
        <div class="accordion" id="user-accordion">

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#info">
                        <i class="icon-dashboard"></i><span class="divide"></span> Account Info
                    </a>
                </div>
                <div id="info" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <table class="table table-bordered table-hover table-striped">
                            <tbody>
                            <tr>
                                <td>Name</td>
                                <td>{{ user.display_name }}</td>
                            </tr>
                            <tr>
                                <td>Email</td>
                                <td>{{ user.email }}</td>
                            </tr>
                            <tr>
                                <td>Games</td>
                                <td>{{ user.get_game_count() }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#notifications">
                        <i class="icon-comment"></i><span class="divide"></span> Notifications
                    </a>
                </div>
                <div id="notifications" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <table class="table table-hover table-striped table-bordered" id="notifications-table">
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Sent</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if notifications %}
                                {% for notification in notifications %}
                                    <tr href="{{ notification.link }}" {% if not notification.read %} class="info" {% endif %} style="cursor: pointer">
                                        <td>{{ notification.title }}</td>
                                        <td>{{ notification.description | safe}}</td>
                                        <td>{{ notification.sent | pretty_date }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" style="text-align: center;"><strong>No Notifications!</strong></td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#games">
                        <i class="icon-trophy"></i><span class="divide"></span> Games
                    </a>
                </div>
                <div id="games" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <table class="table table-bordered table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Name</th>
                                <th>Last Played</th>
                                <th class="col-created">Created</th>
                                <th>Player Participating</th>
                                <th>Actions</th>
                            </tr>
                            </thead>

                            <tbody>
                            {% if games %}
                                {% for game in games %}
                                    <tr>
                                        <td>{{ game.title }}</td>
                                        <td>{{ game.last_updated | pretty_date }}</td>
                                        <td class="col-created">{{ game.created | pretty_date }}</td>
                                        <td>{{ game.occupant_name }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="/game/{{ game.key() }}" class="btn btn-primary"><i class="icon-pencil"></i> Play</a>
                                                <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                                                    <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a href="/game/edit/{{ game.key() }}"><i class="icon-edit"></i> Edit Game</a></li>
                                                    <li><a href="/game/timeline/{{ game.key() }}"><i class="icon-list-alt"></i> View Timeline</a></li>
                                                    {% if current_user.key() == game.created_by.key() %}
                                                        <li><a href="/game/evict/{{ game.key() }}"><i class="icon-unlock"></i> Evict Player</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center;">
                                        <strong><a href="{{ url_for('wizard') }}">Create</a> or <a href="{{ url_for('search') }}">Join</a> a Game!</strong>
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <div class="pull-right">
            <br>
            {% if user.is_base_user() %}

                <a class="btn btn-primary" href="{{ url_for('password') }}">
                    Change Password
                </a>

            {% endif %}

            {% if user.is_facebook_user() %}

                <a class="btn btn-primary" href="{{ url_for('facebook_deauth') }}">
                    <i class="icon-facebook-sign icon-large"></i> Disconnect
                </a>

            {% else %}

                <a class="btn btn-primary" href="{{ url_for('facebook_login') }}">
                    <i class="icon-facebook-sign icon-large"></i> Connect
                </a>

            {% endif %}
        </div>
    </div>

{% endblock content %}

{% block js_include %}

    <script type="text/javascript">

        {# Auto open collapse #}
        var hash = window.location.hash;
        $('a[href^="' + hash + '"]').click();

        {# Make Row clickable #}
        $('#notifications-table tr').click(function(){
            window.location = $(this).attr('href');
            return false;
        });

        {# Mark notifications as read #}
        function readNotifications() {
            $.get({{ url_for('notifications') }})
        }
        $('#notifications').bind('shown', readNotifications());
        $('a[href^="notifications"]').bind('shown', readNotifications());

    </script>

{% endblock %}