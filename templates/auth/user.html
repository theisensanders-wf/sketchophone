{% extends "themes/base.html" %}

{% block style %}
    <style>

        h2 img {
            padding-right: 20px;
        }

        {# Hide Created Column on Mobile #}
        @media (max-width: 480px) {
            .col-created {display: none;}
        }

        div.accordion-inner {
            overflow-x: scroll;
        }

    </style>
{% endblock %}

{% block content %}

    <div class="span10 offset1">
        <h2>
            {% if user.is_facebook_user() %}
                <img src="https://graph.facebook.com/{{ user.facebook_id }}/picture?width=100&height=100" width="100" height="100">
            {% else %}
                <img src="{{ url_for('static', filename="img/blank-facebook.jpg") }}" width="100" height="100">
            {% endif %}
            {{ user.display_name }}
        </h2>

        <hr>
        <div id = "alert_placeholder"></div>
        <div class="accordion" id="user-accordion">

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#info">
                        <i class="icon-dashboard"></i><span class="divide"></span> Account Info
                    </a>
                </div>
                <div id="info" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <table class="table table-bordered table-hover table-striped">
                            <tbody>
                            <tr>
                                <td>Name</td>
                                <td>{{ user.display_name }}</td>
                            </tr>
                            <tr>
                                <td>Email</td>
                                <td>{{ user.email }}</td>
                            </tr>
                            <tr>
                                <td>Games</td>
                                <td>{{ user.get_game_count() }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#notifications">
                        <i class="icon-comment"></i><span class="divide"></span> Notifications
                    </a>
                </div>
                <div id="notifications" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <table class="table table-hover table-striped table-bordered" id="notifications-table">
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Sent</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if notifications %}
                                {% for notification in notifications %}
                                    <tr href="{{ notification.link }}" {% if not notification.read %} class="info" {% endif %} style="cursor: pointer">
                                        <td>{{ notification.title }}</td>
                                        <td>{{ notification.description | safe}}</td>
                                        <td>{{ notification.pretty_date }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" style="text-align: center;"><strong>No Notifications!</strong></td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#games">
                        <i class="icon-trophy"></i><span class="divide"></span> Games
                    </a>
                </div>
                <div id="games" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <table class="table table-bordered table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Name</th>
                                <th>Last Played</th>
                                <th class="col-created">Created</th>
                                <th>Player Participating</th>
                                <th>Actions</th>
                            </tr>
                            </thead>

                            <tbody>
                            {% if games %}
                                {% for game in games %}
                                    <tr>
                                        <td>{{ game.title }}</td>
                                        <td>{{ game.pretty_updated }}</td>
                                        <td class="col-created">{{ game.pretty_created }}</td>
                                        <td>{{ game.occupant_name }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="/game/{{ game.key() }}" class="btn"><i class="icon-pencil"></i> Play</a>
                                                <a href="/game/timeline/{{ game.key() }}" class="btn"><i class="icon-list-alt"></i> View Timeline</a>
                                                <a id="evict_button" value="{{game.key()}}" class="btn"><i class="icon-unlock"></i> Evict User</a>
                                                {% if game.is_over() %}}
                                                <a id="end_game_button" value="{{game.key()}}" class="btn"><i class="icon-fast-forward"></i> End Game</a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center;">
                                        <strong><a href="{{ url_for('wizard') }}">Create</a> or <a href="{{ url_for('search') }}">Join</a> a Game!</strong>
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        {% if user.administrator %}
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#user-accordion" href="#admin">
                        <i class="icon-fighter-jet"></i><span class="divide"></span>Admin Junk
                    </a>
                </div>
                <div id="admin" class="accordion-body collapse">
                    <div class="accordion-inner">
                        Rember with great power comes great responsibility...

                        <table class="table table-bordered table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Type</th>
                                <th>Created</th>
                                <th>User</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if flags %}
                                {% for flag in flags %}
                                    <tr id="{{ flag.key() }}">
                                        <td>{{ flag.round_type }}</td>
                                        <td>{{ flag.get_date_formatted() }}</td>
                                        <td>{{ flag.user.display_name }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="/game/examine/{{ flag.key() }}" class="btn" href="">Inspect</a>
                                                <button class="btn ban-round" value="{{ flag.key() }}">Ban</button>
                                                <button class="btn unflag-round" value="{{ flag.key() }}">Dismiss</button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center;">
                                        <strong>Well it looks like your job here is done!</strong>
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}

        </div>

        <div class="pull-right">
            <br>
            {% if user.is_base_user() %}

                <a class="btn btn-primary" href="{{ url_for('password') }}">
                    Change Password
                </a>

            {% endif %}

            {% if user.is_facebook_user() %}

                <a class="btn btn-primary" href="{{ url_for('facebook_deauth') }}">
                    <i class="icon-facebook-sign icon-large"></i> Disconnect
                </a>

            {% else %}

                <a class="btn btn-primary" href="{{ url_for('facebook_login') }}">
                    <i class="icon-facebook-sign icon-large"></i> Connect
                </a>

            {% endif %}
        </div>
    </div>

{% endblock content %}

{% block js_include %}

    <script type="text/javascript">

        var hash = window.location.hash;
        $('a[href^="' + hash + '"]').click();

        {# Make Row clickable #}
        $('#notifications-table tr').click(function(){
            window.location = $(this).attr('href');
            return false;
        });

        {# Set active tab (Ex: 'url'#games) #}
        $(function () {
            var activeTab = $('[href=' + location.hash + ']');
            activeTab && activeTab.tab('show');
        });

        {# Mark notifications as read #}
        $('#notifications').on('shown', function (e) {
            var active_tab = e.target
            if (active_tab.id == 'notifications') {
                $.get('/auth/notifications')
            }
        })
        var showWarniing = function(message) {
            $('#alert_placeholder').html('<div class="alert alert-success"><a class="close" data-dismiss="alert">×</a><span>'+message+'</span></div>');

            $(".alert").delay(3000).fadeOut("slow", function () { $(this).remove(); });
        }
        $('#evict_button').click(function(){
            var game_key = $(this).attr("value");
            $.ajax({
                type: "POST",
                url: "/game/sketch/"+game_key,
                data: JSON.stringify({
                    evict_user:true
                }),
                contentType: 'application/json',
                dataType: 'json',
            });

            showWarniing('Game has been cleared!');
        });

        $('#end_game_button').click(function(){
            var game_key = $(this).attr("value");
            $.ajax({
                type: "POST",
                url: "{{ url_for('end_game') }}",
                data: JSON.stringify({
                    game_key: game_key
                }),
                contentType: 'application/json',
                dataType: 'json',
            });

            showWarniing('Game has ended!');
            $(this).remove();
        });

        $(".ban-round").click(function(){
            $.ajax({
                type: "POST",
                url: "{{ url_for('ban_round') }}",
                data: JSON.stringify({
                    round_key: $(this).val(),
                    state: true
                }),
                contentType: 'application/json',
                dataType: 'json',
            });
            $('#'+$(this).val()).remove();
        });

        $(".unflag-round").click(function(){
            $.ajax({
                type: "POST",
                url: "{{ url_for('flag_round') }}",
                data: JSON.stringify({
                    round_key: $(this).val(),
                    state: false
                }),
                contentType: 'application/json',
                dataType: 'json',
            });
            $('#'+$(this).val()).remove();
        });

    </script>

{% endblock %}